<script>
  s.content = new (function() {
    this.propertys = 'added,discriminator,time,outdated'.split(',');
    this.datePropertys = 'added,outdated'.split(',');
    this.buildLessonRangesTable = () => {
      request('/data/lessonranges', function(err, statusCode, body) {
        if(err || statusCode !== 200) return alert('sth went wrong: ' + (err || 'statusCode ' + statusCode));
        let table = document.getElementById('lessonranges').children[0];
        let data = JSON.parse(body);
        while(table.childElementCount > 1) table.removeChild(table.children[1]);
        for(const entry of data) {
          let row = document.createElement('tr');
          for(const prop of s.content.propertys) {
            let toadd = document.createElement('td');
            if(s.content.datePropertys && s.content.datePropertys.includes(prop)) toadd.innerText = entry[prop] ? new Date(Number(entry[prop].substr(2))).toGMTString() : 'null';
            else if(s.content.booleanPropertys && s.content.booleanPropertys.includes(prop)) toadd.innerText = entry[prop] === 1 ? 'y' : 'n';
            else toadd.innerText = entry[prop];
            row.appendChild(toadd);
          }
          let edit = document.createElement('td');
          const i = document.createElement('i');
          i.className = 'material-icons';
          i.innerText = 'mode edit';
          i.onclick = () => s.content.editEntry(entry);
          edit.appendChild(i);
          const i2 = document.createElement('i');
          i2.className = 'material-icons';
          i2.innerText = 'delete';
          i2.onclick = () => s.content.delEntry(entry);
          edit.appendChild(i2);
          row.appendChild(edit);
          table.appendChild(row);
        }
      });
    }
    this.delEntry = (entry) => {
      request('/data/lessonranges', function(err, statusCode, body) {
        if(err || statusCode !== 200) return alert('sth went wrong: ' + (err || 'statusCode ' + statusCode));
        s.content.buildLessonRangesTable();
      }, 'DELETE', JSON.stringify(entry.uuid));
    }
    this.editEntry = (entry) => {
      document.getElementById("edit_added").value = new Date(Number(entry.added.substr(2))- new Date(Number(entry.added.substr(2))).getTimezoneOffset()*60*1000).toISOString().slice(0, -1);
      document.getElementById("edit_discriminator").value = entry.discriminator;
      document.getElementById("edit_time").value = entry.time;
      document.getElementById("edit_outdated").value = entry.outdated ? new Date(Number(entry.outdated.substr(2)) - new Date(Number(entry.outdated.substr(2))).getTimezoneOffset()*60*1000).toISOString().slice(0, -1) : null;
      document.getElementById("edit_submit").onclick = () => s.content.doEdit(entry)
    }
    this.doAdd = () => {
      request('/data/lessonranges', function(err, statusCode, body) {
        if(err || statusCode !== 200) return alert('sth went wrong: ' + (err || 'statusCode ' + statusCode));
        s.content.buildLessonRangesTable();
      }, 'PUT', JSON.stringify({
        added: document.getElementById("add_added").value ? 'DT' + new Date(document.getElementById("add_added").value).getTime() : null,
        discriminator: document.getElementById("add_discriminator").value || null,
        time: document.getElementById("add_time").value || null,
        outdated: document.getElementById("add_outdated").value ? 'DT' + new Date(document.getElementById("add_outdated").value).getTime() : null
      }));
    }
    this.doEdit = (entry) => {
      let added = document.getElementById("edit_added").value ? 'DT' + new Date(document.getElementById("edit_added").value).getTime() : null;
      let discriminator = document.getElementById("edit_discriminator").value || null;
      let time = document.getElementById("edit_time").value || null;
      let outdated = document.getElementById("edit_outdated").value ? 'DT' + new Date(document.getElementById("edit_outdated").value).getTime() : null;

      let changes = { uuid: entry.uuid }
      if(added !== entry.added) changes.added = added;
      if(discriminator !== entry.discriminator) changes.discriminator = discriminator;
      if(time !== entry.time) changes.time = time;
      if(outdated !== entry.outdated) changes.outdated = outdated;

      request('/data/lessonranges', function(err, statusCode, body) {
        if(err || statusCode !== 200) return alert('sth went wrong: ' + (err || 'statusCode ' + statusCode));
        s.content.buildLessonRangesTable();
      }, 'POST', JSON.stringify(changes));
    }
    this.setDefaultDates = () => {
      for(const e of document.getElementsByClassName('datePicker-now'))
        e.value = new Date(Date.now() - new Date().getTimezoneOffset() * 60 * 1000).toISOString().slice(0, -1);
    }
  })();
  s.content.setDefaultDates();
  s.content.buildLessonRangesTable();
</script>
<style>
  table {
    background: #00afec;
  }
</style>
<div>
  <table id="lessonranges" style="width:100%" border="1">
    <tr>
      <th onclick="sortTable.call(this)">added</th>
      <th onclick="sortTable.call(this)">discriminator</th>
      <th onclick="sortTable.call(this)">time</th>
      <th onclick="sortTable.call(this)">outdated</th>
    </tr>
  </table>
  <button onclick="s.content.buildLessonRangesTable()">refreshData</button>
</div>
<hr>
<div>
  add
  <table border="1">
    <tr>
      <th>added</th>
      <th>discriminator</th>
      <th>time</th>
      <th>outdated</th>
    </tr>
    <tr>
      <td><input id="add_added" class="datePicker-now" type=datetime-local step="1"></td>
      <td><input id="add_discriminator" type=text></td>
      <td><input id="add_time" type=text></td>
      <td><input id="add_outdated" type=datetime-local step="1"></td>
    </tr>
  </table>
  <button onclick="s.content.doAdd()">addItem</button>
</div>
<hr>
<div>
  edit
  <table border="1">
    <tr>
      <th>added</th>
      <th>discriminator</th>
      <th>time</th>
      <th>outdated</th>
    </tr>
    <tr>
      <td><input id="edit_added" type=datetime-local step="1"></td>
      <td><input id="edit_discriminator" type=text></td>
      <td><input id="edit_time" type=text></td>
      <td><input id="edit_outdated" type=datetime-local step="1"></td>
    </tr>
  </table>
  <button id="edit_submit">editItem</button>
</div>
