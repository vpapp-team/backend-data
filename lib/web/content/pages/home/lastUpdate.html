<script>
  s.content = new (function() {
    this.propertys = 'category,lastUpdate'.split(',');
    this.categories = 'calendar,lessonranges,menu,stand-in,teachers,timetables,version,rooms'.split(',');
    this.buildLastUpdateTable = () => {
      request('/data/lastupdate', function(err, statusCode, body) {
        if(err || statusCode !== 200) return alert('sth went wrong: ' + (err || 'statusCode ' + statusCode));
        let table = document.getElementById('lastupdate').children[0];
        let data = JSON.parse(body);
        while(table.childElementCount > 1) table.removeChild(table.children[1]);
        for(let a = 0 ; a < s.content.categories.length ; a++) {
          let row = document.createElement('tr');
          let cat = document.createElement('td');
          cat.innerText = s.content.categories[a];
          row.appendChild(cat);
          let val = document.createElement('td');
          let matching = data.find(d => d.category === s.content.categories[a]);
          val.innerText =  matching ? new Date(Number(matching.lastUpdate.substr(2))).toGMTString() : '/';
          row.appendChild(val);
          let del = document.createElement('td');
          const i = document.createElement('i');
          i.className = 'material-icons';
          i.innerText = 'delete';
          i.onclick = () => s.content.delEntry(s.content.categories[a]);
          const b = document.createElement('button');
          b.innerText = 'setNow';
          b.onclick = () => s.content.editEntry(s.content.categories[a], Date.now());
          del.appendChild(i);
          del.appendChild(b);
          row.appendChild(del);
          table.appendChild(row);
        }
      });
    }
    this.editEntry = (category, time) => {
      request('/data/lastupdate', function(err, statusCode, body) {
        if(err || statusCode !== 200) return alert('sth went wrong: ' + (err || 'statusCode ' + statusCode));
        s.content.buildLastUpdateTable();
      }, "POST", JSON.stringify({
        lastUpdate: 'DT' + time,
        category
      }));
    }
    this.delEntry = (category) => {
      request('/data/lastupdate', function(err, statusCode, body) {
        if(err || statusCode !== 200) return alert('sth went wrong: ' + (err || 'statusCode ' + statusCode));
        s.content.buildLastUpdateTable();
      }, "DELETE", JSON.stringify(category));
    }
    this.sendLastUpdateData = () => {
      const newTime = new Date(document.getElementById('datePicker').value).getTime();
      const cat = document.getElementById('categorySelector1').value;
      s.content.editEntry(cat, newTime);
    }
    this.sendDeleteLastUpdate = () => {
      const cat = document.getElementById('categorySelector2').value;
      s.content.delEntry(cat);
    }
    this.setDefaultDates = () => {
      for(const e of document.getElementsByClassName('datePicker-now'))
        e.value = new Date(Date.now() - new Date().getTimezoneOffset() * 60 * 1000).toISOString().slice(0, -1);
    }
    this.buildCategorySelectors = () => {
      const holders = document.getElementsByClassName('categorySelector');
      for(const holder of holders) {
        holder.innerHTML = '';
        for(const cat of s.content.categories) {
          const toadd = document.createElement('option');
          toadd.value = cat;
          toadd.innerText = cat;
          holder.appendChild(toadd);
        }
      }
    }
  })();
  s.content.buildCategorySelectors();
  s.content.buildLastUpdateTable();
  s.content.setDefaultDates();
</script>
<style>
  table {
    background: #00afec;
  }
</style>
<div>
  <table id="lastupdate" style="width:100%" border="1">
    <tr>
      <th onclick="sortTable.call(this)">Kategorie</th>
      <th onclick="sortTable.call(this)">zuletzt Geupdated</th>
    </tr>
  </table>
  <button onclick="s.content.buildLastUpdateTable()">refreshData</button>
</div>
<hr>
<div>
  OverwriteLastUpdate
  <select class="categorySelector" id="categorySelector1">
  </select>
  <input id="datePicker" class="datePicker-now" type=datetime-local step="1"></td>
  <button onclick="s.content.sendLastUpdateData()">updateData</button>
</div>
<hr>
<div>
  RemoveItem
  <select class="categorySelector" id="categorySelector2">
  </select>
  <button onclick="s.content.sendDeleteLastUpdate()">deleteData</button>
</div>
