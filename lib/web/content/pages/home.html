<script>
  var s = new (function() {
    this.content = null;
    this.toggleBar = () => {
      document.getElementById('nav-burger').classList.toggle('showing');
      document.getElementById('leftnav').classList.toggle('showing');
    }
    this.unloadContent = () => {
      this.content = null;
    }
    this.loadContent = (module, trys = 3) => {
      if(!module) {
        this.unloadContent();
        return this.loadDefaultContent();
      }
      if(trys === 0) return alert('failed - to many retrys');
      request(`/content/pages/home/${module}.html`, function(err, statusCode, body) {
        if(err || statusCode !== 200) return s.loadContent(module, trys - 1);
        document.getElementById('content').innerHTML = body;
        executeScripts(document.getElementById('content'));
      });
    }
    this.logout = () => {
      request('/data/logout', function(err, statusCode, body) {
        if(err) return alert('logout failed');
        try {
          let parsed = JSON.parse(body);
          if(parsed.error) return alert('logout failed - ' + parsed.error);
          if(statusCode !== 200) return alert('logout failed - server responded with code ' + statusCode);
        } catch(e) {
          return alert('logout failed');
        }
        profile = null;
        clean(function() {
          loadPage('./content/pages/login.html', function() {
            window.history.pushState(null, null, '/login');
          });
        });
      }, 'POST');
    }
    this.loadProfilePic = () => {
      for(var item of document.getElementsByClassName('user-image-holder')) item.src = profile.avatar;
    }
    this.loadDefaultContent = () => {
      document.getElementById('content').innerHTML = '<b> MAIN </b><br>Profile:<br>' + JSON.stringify(profile, null, 2).replace(/\n/g, '<br>');
    }
    this.addMenuItem = (ref, name, icon, active) => {
      const wrapper = document.createElement('a');
      wrapper.className = 'nav-item' + (active ? ' active' : '');
      wrapper.onclick = () => {
        s.loadContent(ref);
        s.toggleBar();
        for(const c of document.getElementById('nav-content').children) c.classList.remove('active');
        wrapper.classList.add('active');
      }
      const iconHolder = document.createElement('div');
      iconHolder.className = 'nav-item-image';
      const i = document.createElement('i');
      i.className = 'material-icons';
      i.innerText = icon;
      iconHolder.appendChild(i);
      wrapper.appendChild(iconHolder);
      const txt = document.createElement('div');
      txt.className = 'nav-item-name';
      txt.innerText = name;
      wrapper.appendChild(txt);
      document.getElementById('nav-content').appendChild(wrapper);
    }
  })();
  s.addMenuItem(null, 'Home', 'home', true);
  s.addMenuItem('lastUpdate', 'LastUpdate', 'update');
  s.addMenuItem('lessonRanges', 'LessonRanges', 'timer');
  s.addMenuItem('teachers', 'Teachers', 'school');
  s.addMenuItem('versions', 'Versions', 'widgets');
  s.loadProfilePic();
  s.loadDefaultContent();
  registerPrevLocation('/home');
</script>
<topnav>
  <div class="topnav">
    <div class="logo-container">
      <a routerlink href="/" style="display: inline;">
        <img src="/content/icons/logo-txt-150x33.png" style="display: inline;">
      </a>
    </div>
    <div id="nav-burger" class="nav-burger" onclick="s.toggleBar()">
      <div class="bar-one"></div>
      <div class="bar-two"></div>
      <div class="bar-three"></div>
    </div>
    <div class="user-profile">
      <div class="profile-image-rounded" onclick="this.parentElement.classList.toggle('visible')">
        <img class="user-image-holder">
      </div>
      <div class="dropdown">
        <div class="dropdown-item" routerlink="/user/settings" tabindex="0">
          Account Settings
          <i class="material-icons">settings</i>
        </div>
        <div class="dropdown-item" routerlink="/user/subscriptions" tabindex="0">
          Manage Subscriptions
          <i class="material-icons">beenhere</i>
        </div>
        <div class="dropdown-item" routerlink="/user/watched" tabindex="0">
          Watch History
          <i class="material-icons">slow_motion_video</i>
        </div>
        <div class="dropdown-item" tabindex="0">
          My Profile
          <i class="material-icons">person</i>
        </div>
        <div class="dropdown-item" onclick="s.logout()">
          Sign out
          <i class="material-icons">power_settings_new</i>
        </div>
      </div>
    </div>
  </div>
</topnav>
<leftnav>
  <div id="leftnav" class="leftnav">
    <div class="logo-container">
      <a routerlink="/" href="/">
        <img class="small" src="/content/icons/logo-icon-40.png">
        <img class="big" src="/content/icons/logo-txt-150x33.png">
      </a>
    </div>
    <div class="nav-content" id="nav-content">
    </div>
    <div class="anchor-bottom nav-item">
      <a id="user-profile" class="user-profile" href="/user/profile" onclick="window.innerWidth <= 1200 && !event.preventDefault() && document.getElementById('user-profile').classList.toggle('open');">
        <div class="dropup">
          <div class="dropup-item" routerlink="/user/login" tabindex="0"  onclick="s.logout()">
            <i class="material-icons">power_settings_new</i>
            Sign out
          </div>
          <div class="dropup-item" routerlink="/user/Settings" tabindex="0">
            <i class="material-icons">settings</i>
            Settings
          </div>
          <div class="dropup-item" tabindex="0">
            <i class="material-icons">person</i>
            Profile
          </div>
        </div>
        <div class="channel-image">
          <img class="user-image-holder">
        </div>
        <div class="channel-name">
          <span>TimeForANinja</span>
        </div>
      </a>
      <a class="nav-settings" onclick="document.getElementById('user-profile').classList.toggle('open');">
        <div class="dropup">
          <div class="dropup-item" routerlink="/user/login" tabindex="0" onclick="s.logout()">
            <i class="material-icons">power_settings_new</i>
            Sign out
          </div>
          <div class="dropup-item" routerlink="/user/settings" tabindex="0">
            <i class="material-icons">settings</i>
            Settings
          </div>
        </div>
        <i class="material-icons spinny-gear">settings</i>
      </a>
    </div>
  </div>
  <div id="leftnav-cover" class="leftnav-cover" onclick="s.toggleBar()"></div>
</leftnav>
<content>
  <div id="content" class="content"></div>
</content>
